{% extends 'base.html.twig' %} 
{% block title %}Dotation vestimentaire{% endblock %}


{% block sidebar %}
    {% include 'dotation/sidebar.html.twig' with {'active_link': 'catalogue'} %}
{% endblock %}


{% block body %}


<div class="container mt-4" id="top-logo">
    <div class="row align-items-center">
        <div class="col-md-3 d-flex align-items-center">
            <span class="mr-2">Points disponibles :</span>
            <strong>{{ app.user.pointDotation }}P</strong>
        </div>

        <div class="col-md-6" id="searchbar">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Search" aria-label="Search" aria-describedby="button-addon2">
                <div class="input-group-append">
                  <button class="btn btn-primary" type="button" id="button-addon2" disabled><i class="fas fa-search"></i></button>
                </div>
            </div>
        </div>

        <div class="col-md-3 d-flex justify-content-end align-items-center" id="icons">
            <a href="/dota/panier" class="d-inline-block">
                <div class="circle mr-2"><i class="fas fa-shopping-cart text-primary"></i>
                    <sup><span class="badge badge-danger" style="width: 23px;">{% if nombreArticles is defined %}{{nombreArticles}}{% else %}0{% endif %}</span></sup>
                </div>
            </a>
        </div>
    </div>
</div>


 {# <div class="container">
  <div id="carouselExampleControls" class="carousel slide" data-ride="carousel">
    <div class="carousel-inner">
      <div class="carousel-item active">
        <img class="d-block w-100" src="https://images.ctfassets.net/1nw0m35kh5t7/6kI0OuYTrVywhKOyUd1kDi/ed6186f9da8feb4464ec6f9e238e6073/Types-of-e-commerce-16-9" alt="First slide" class="img-fluid">
      </div>
      <div class="carousel-item">
        <img class="d-block w-100" src="https://assets.entrepreneur.com/content/3x2/2000/20191127134656-e-commerce-3406613.jpeg?width=600&crop=16:9" alt="Second slide" class="img-fluid">
      </div>
      <div class="carousel-item">
        <img class="d-block w-100" src="https://media.newyorker.com/photos/5b465113da42df0b560981d3/16:9/w_1280,c_limit/180723_r32444_rd.jpg" alt="Third slide" class="img-fluid">
      </div>
    </div>
    <a class="carousel-control-prev" href="#carouselExampleControls" role="button" data-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="sr-only">Previous</span>
    </a>
    <a class="carousel-control-next" href="#carouselExampleControls" role="button" data-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="sr-only">Next</span>
    </a>
  </div>
 </div> #}


<br> <br>

<div class="container cardItem" id="products">

  <div class="container">
    <!-- Une seule row : Bootstrap gère automatiquement le wrapping -->
    <div class="row">
      {% set currentType = null %}
      {% for product in listeArticles %}
        {% if product.nomType != currentType %}
          {% set currentType = product.nomType %}
          <div class="w-100"><h3 class="mt-4 mb-3">{{ currentType }}</h3></div>
        {% endif %}

        <div class="col-md-3 col-sm-6 mb-4">
          <div class="card h-100" data-nom="{{ product.nom | lower }}">
            <p class="pl-2">{{ product.reference }}</p>
            <img class="card-img-top img-fluid"
                 src="{{ product.image is not empty ? asset('uploads/images/' ~ product.image) : asset('img/defaultimage.png') }}"
                 alt="{{ product.nom }}">
            <div class="card-body d-flex flex-column">
              <p class="card-text">{{ product.nom }}</p>
              <p class="card-cost">{{ product.point }} P</p>
              <p class="card-cost">{{ product.description }}</p>

              <!-- Formulaire d'ajout au panier (1 formulaire par carte) -->
              <form method="POST" action="{{ path('add_to_cart') }}" class="mt-auto add-to-cart-form" data-product-id="{{ product.id }}">
                <input type="hidden" name="product_id" value="{{ product.id }}">
                <input type="hidden" name="size" value="">
                <input type="hidden" name="color" value="">
                <input type="hidden" name="quantity" value="1">
                <button type="submit" class="btn btn-sm btn-light btn-block mt-3">
                  <i class="fas fa-shopping-cart pr-2"></i> Ajouter au panier
                </button>
              </form>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>


<br>
<br>
  

<!-- Modal de confirmation -->
<div class="modal fade" id="confirmAddModal" tabindex="-1" role="dialog" aria-labelledby="confirmAddModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body text-center">
        <p>Article ajouté au panier. Que souhaitez-vous faire ?</p>
        <div class="d-flex justify-content-around mt-3">
          <button type="button" id="continueShoppingBtn" class="btn btn-secondary">Continuer mes achats</button>
          <button type="button" id="goToCartBtn" class="btn btn-primary">Aller au panier</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script src="js/script.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.querySelector('#searchbar input');
    // cibler uniquement les colonnes du catalogue
    const columns = Array.from(document.querySelectorAll('#products .col-md-3'));

    // écoute sur 'input' pour réagir au fur et à mesure
    searchInput.addEventListener('input', function () {
        const query = searchInput.value.trim().toLowerCase();

        // Affiche/masque chaque colonne sans toucher à la structure des lignes
        columns.forEach(column => {
            const card = column.querySelector('.card');
            const productName = card ? (card.getAttribute('data-nom') || '') : '';
            if (query === '' || productName.includes(query)) {
                column.style.display = ''; // restaure le style par défaut (Bootstrap gère le layout)
            } else {
                column.style.display = 'none';
            }
        });
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Gère les formulaires d'ajout au panier
    const forms = document.querySelectorAll('.add-to-cart-form');
    const badge = document.querySelector('#icons .badge');
    let pendingForm = null;

    function updateHiddenFields(form) {
        // récupère taille / couleur / quantité choisis dans le même card
        const card = form.closest('.card');
        const quantityInput = card.querySelector('input[name="quantity"]') || card.querySelector('.numberbox1');
        const sizeInput = card.querySelector('input[name="size"]:checked') || card.querySelector('input[name="size"]');
        const colorInput = card.querySelector('input[name="color"]:checked') || card.querySelector('input[name="color"]');

        form.querySelector('input[name="quantity"]').value = quantityInput ? quantityInput.value : 1;
        form.querySelector('input[name="size"]').value = (card.querySelector('input[type="radio"][name="size"]:checked') || {value: ''}).value;
        form.querySelector('input[name="color"]').value = (card.querySelector('input[type="radio"][name="color"]:checked') || {value: ''}).value;
    }

    forms.forEach(form => {
        // prevent default on submit to show modal first
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            pendingForm = form;
            updateHiddenFields(form);
            // show bootstrap modal
            $('#confirmAddModal').modal('show');
        });
    });

    // Continuer les achats: envoie en background et met à jour le badge
    document.getElementById('continueShoppingBtn').addEventListener('click', function () {
        if (!pendingForm) { $('#confirmAddModal').modal('hide'); return; }
        const fd = new FormData(pendingForm);
        fetch(pendingForm.action, {
            method: 'POST',
            body: fd,
            credentials: 'same-origin',
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        }).then(resp => {
            // incrémente le badge visuel (simple estimation côté client)
            try {
                const current = parseInt(badge.textContent.trim() || '0', 10);
                const added = parseInt(fd.get('quantity') || '1', 10);
                badge.textContent = current + added;
            } catch (e) {}
        }).catch(()=>{})
        .finally(()=> {
            $('#confirmAddModal').modal('hide');
            pendingForm = null;
        });
    });

    // Aller au panier: soumet normalement (redirigera vers la page panier)
    document.getElementById('goToCartBtn').addEventListener('click', function () {
        if (!pendingForm) { $('#confirmAddModal').modal('hide'); return; }
        // avant soumission normale, s'assurer que les champs cachés sont à jour
        updateHiddenFields(pendingForm);
        // soumission normale pour suivre la redirection côté serveur
        pendingForm.submit();
    });
});
</script>

{% endblock %}
