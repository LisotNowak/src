{% extends 'base.html.twig' %} 
{% block title %}Dotation vestimentaire{% endblock %}

{% block sidebar %}
    {% include 'dotation/sidebar.html.twig' with {'active_link': 'null'} %}
{% endblock %}

{% block body %}
<div class="container mt-4" id="top-logo">
    <div class="row align-items-center">
        <div class="col-md-3 d-flex align-items-center">
            {% set totalPoints = 0 %}
            {% for type, articles in panierGrouped %}
                {% for article in articles %}
                    {% set totalPoints = totalPoints + (article.point * article.quantite) %}
                {% endfor %}
            {% endfor %}
            {% set remaining = (app.user.pointDotation - totalPoints) < 0 ? 0 : (app.user.pointDotation - totalPoints) %}
            <div>
                <div><span class="mr-2">Points disponibles :</span><strong id="totalPoints" data-value="{{ app.user.pointDotation }}">{{ app.user.pointDotation }} P</strong></div>
                <div class="text-muted small">Points dans le panier : <span id="pointsInCart" data-value="{{ totalPoints }}">{{ totalPoints }} P</span></div>
                <div class="mt-1"><strong>Points restants : <span id="pointsRemaining" data-value="{{ remaining }}">{{ remaining }} P</span></strong></div>
            </div>
        </div>
        
        <div class="col-md-8"></div>

        <div class="col-md-1 d-flex justify-content-end align-items-center" id="icons">          
          <a href="/dota/panier" class="d-inline-block">
            <div class="circle me-2">
              <i class="fas fa-shopping-cart text-primary"></i>
              <sup>
                <span id="cartBadge" class="badge bg-danger" style="width: 23px;">
                  {% if nombreArticles is defined %}{{ nombreArticles }}{% else %}0{% endif %}
                </span>
              </sup>
            </div>
          </a>
        </div>
    </div>
</div>

<hr>
{% for label, messages in app.flashes %}
    {% for message in messages %}
        <div class="alert alert-{{ label == 'error' ? 'danger' : label }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
{% endfor %}

<div class="cart">
    <div class="container">
        <h3 class="text-center">Détails du panier</h3>
    </div>
</div>

<br><br>

<div class="container" id="card">
    <div class="row">
        <div class="col-md-8">
            <div class="card p-4" id="cards">
                <h5 class="text-dark">Panier ({{ nombreArticles }} articles)</h5>

                {% for type, articles in panierGrouped %}
                    <div class="w-100"><h4 class="mt-3 mb-2">{{ type }}</h4></div>
                    {% for article in articles %}
                        <div class="row cart-row" data-points="{{ article.point * article.quantite }}">
                            <div class="col-md-3">
                                <div class="overlay"> 
                                    <img src="{{ (article.image is defined and article.image is not empty) ? asset('uploads/images/' ~ article.image) : asset('img/defaultimage.png?v=1648567836&width=1080') }}" class="zoom-in figure-img img-fluid" alt="{{ article.nom }}">
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h5 class="text-muted pt-2">{{ article.nom }}</h5>
                                <p class="text-uppercase font-weight-light">{{ article.reference }}</p>
                                <div class="linespace mb-4">
                                    <p class="text-muted mt-4">Points : {{ article.point }}P</p>
                                    <p class="text-muted mt-4">{{ article.description }}</p>
                                    <p class="text-muted">Taille : {{ article.taille }}</p>
                                    <p class="text-muted">Couleur : {{ article.couleur }}</p>
                                </div>

                                <form method="POST" action="{{ path('remove_from_cart') }}" class="d-inline">
                                    <input type="hidden" name="product_id" value="{{ article.id }}">
                                    <input type="hidden" name="size" value="{{ article.taille }}">
                                    <input type="hidden" name="color" value="{{ article.couleur }}">
                                    <button type="submit" class="btn btn-danger btn-sm mt-2">
                                        <i class="fas fa-trash-alt pr-2"></i> SUPPRIMER ARTICLE
                                    </button>
                                </form>

                            </div>

                            <div class="col-md-3">
                                <form method="POST" action="{{ path('update_cart') }}">
                                    <input type="hidden" name="product_id" value="{{ article.id }}">
                                    <input type="hidden" name="size" value="{{ article.taille }}">
                                    <input type="hidden" name="color" value="{{ article.couleur }}">
                                    <div class="input-group">
                                        <input type="number" name="quantity" class="numberbox3 form-control" value="{{ article.quantite }}" min="0" data-point="{{ article.point }}">
                                        <button class="btn btn-primary" type="submit">Modifier</button>
                                    </div>

                                </form>
                            </div>
                        </div>
                        <hr>
                    {% endfor %}
                {% endfor %}
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-3" id="card-cost">
                <h5 class="text-primary pl-2">Récapitulatif :</h5>
                <table class="table table-borderless pt-2">
                    <tbody>
                        {% set totalPoints = 0 %}
                        {% for type, articles in panierGrouped %}
                            <tr>
                                <th colspan="2" class="font-weight-bold">{{ type }}</th>
                            </tr>
                            {% for article in articles %}
                                <tr>
                                    <th scope="row" class="font-weight-light">{{ article.nom }} {{ article.taille }} {{ article.couleur }} X {{ article.quantite }}</th>
                                    <td>{{ (article.point * article.quantite) }}P</td>
                                    {% set totalPoints = totalPoints + (article.point * article.quantite) %}
                                </tr>
                            {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
                <hr>
                <h6 class="pl-2 pt-1">Total :<span class="float-right" id="total-points">{{ totalPoints }}P</span></h6>
                <hr>

                <div id="alert-points" class="alert alert-danger mt-2" style="display: none;">
                    Vous n'avez pas assez de points pour valider ce panier.
                </div>

                <form method="POST" action="{{ path('valider_panier') }}" id="form-valider">
                    <button class="btn btn-primary mt-2" type="submit" id="btn-valider">
                        <i class="fas fa-shopping-bag pr-2"></i> Valider le panier
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<br><br>

<div id="points-disponibles" data-points="{{ app.user.pointDotation }}"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const totalPointsEl = document.getElementById('totalPoints');
    const pointsInCartEl = document.getElementById('pointsInCart');
    const pointsRemainingEl = document.getElementById('pointsRemaining');
    const inputs = document.querySelectorAll('.numberbox3');
    const alertPoints = document.getElementById('alert-points');
    const btnValider = document.getElementById('btn-valider');
    
    const pointsDisponibles = parseInt(totalPointsEl.dataset.value);

    function updateTotal() {
        let total = 0;
        inputs.forEach(input => {
            let point = parseInt(input.dataset.point);
            let quantity = parseInt(input.value) || 0;
            total += point * quantity;
        });
        
        // Mise à jour des éléments d'affichage
        pointsInCartEl.textContent = total + ' P';
        pointsInCartEl.dataset.value = total;
        
        const remaining = Math.max(pointsDisponibles - total, 0);
        pointsRemainingEl.textContent = remaining + ' P';
        pointsRemainingEl.dataset.value = remaining;

        if(total > pointsDisponibles) {
            alertPoints.style.display = 'block';
            document.querySelectorAll('.input-group button').forEach(btn => btn.disabled = true);
            btnValider.disabled = true;
        } else {
            alertPoints.style.display = 'none';
            document.querySelectorAll('.input-group button').forEach(btn => btn.disabled = false);
            btnValider.disabled = false;
        }
    }

    inputs.forEach(input => input.addEventListener('input', updateTotal));

    updateTotal(); // calcul initial
});
</script>
{% endblock %}
