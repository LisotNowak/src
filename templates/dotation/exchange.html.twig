{% extends 'base.html.twig' %}

{% block title %}Demande d'échange{% endblock %}

{% block sidebar %}
    {% include 'dotation/sidebar.html.twig' with {'active_link': 'echange'} %}
{% endblock %}

{% block body %}
<div class="container mt-4">

    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ label }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endfor %}

    <h1>Demande d'échange d'article</h1>
    <p>Sélectionnez l'article que vous souhaitez retourner et choisissez un nouvel article en remplacement.</p>
    <hr>

    <form method="POST" action="{{ path('app_exchange_request') }}"> 
        <div class="row">

            <div class="col-md-6">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <strong class="text-primary">1. Article à retourner</strong>
                    </div>
                    <div class="card-body">

                        <div class="mb-3">
                            <label for="old_item" class="form-label">Article de vos commandes précédentes :</label>
                            <select class="form-select" id="old_item" name="old_item_assoc_id" required>
                                <option value="" disabled selected>-- Sélectionnez un article --</option>
                                {% for commande in commandes %}
                                    <optgroup label="Commande du {{ commande.commande.date|date('d/m/Y') }}">
                                        {% for item in commande.items %}
                                            <option value="{{ item.assoc.id }}">
                                                {{ item.article.nom }} (Taille: {{ item.taille }}, Couleur: {{ item.couleur }})
                                            </option>
                                        {% endfor %}
                                    </optgroup>
                                {% endfor %}
                                {% if commandes is empty %}
                                    <option disabled>Aucun article dans votre historique</option>
                                {% endif %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="reason" class="form-label">Motif de l'échange :</label>
                            <textarea class="form-control" id="reason" name="reason" rows="3" required placeholder="Ex: Taille trop petite, article défectueux..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <strong class="text-primary">2. Nouvel article souhaité</strong>
                    </div>
                    <div class="card-body">

                        <div class="mb-3">
                            <label for="new_article" class="form-label">Nouvel article :</label>
                            <select class="form-select" id="new_article" name="new_article_id" required>
                                <option value="" disabled selected>-- Sélectionnez un article --</option>
                                {% for article in allArticles %}
                                    <option value="{{ article.id }}">{{ article.nom }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="new_size" class="form-label">Taille :</label>
                            <select class="form-select" id="new_size" name="new_size" required disabled>
                                <option>Veuillez d'abord choisir un article</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="new_color" class="form-label">Couleur :</label>
                            <select class="form-select" id="new_color" name="new_color" required disabled>
                                <option>Veuillez d'abord choisir un article</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                <i class="fas fa-exchange-alt"></i> Envoyer la demande d'échange
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const articleSelect = document.getElementById('new_article');
    const tailleSelect = document.getElementById('new_size');
    const couleurSelect = document.getElementById('new_color');
    const submitBtn = document.getElementById('submitBtn');

    function toggleSubmitButton() {
        submitBtn.disabled = !(articleSelect.value && tailleSelect.value && couleurSelect.value);
    }

    articleSelect.addEventListener('change', function() {
        tailleSelect.innerHTML = '<option value="">-- Choisissez une taille --</option>';
        tailleSelect.disabled = true;
        couleurSelect.innerHTML = '<option value="">-- Choisissez une couleur --</option>';
        couleurSelect.disabled = true;
        toggleSubmitButton();

        if (!this.value) return;

        fetch(`/dota/article`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: 'id=' + encodeURIComponent(this.value)
        })
        .then(response => response.json())
        .then(data => {
            // On récupère bien les noms renvoyés par le backend
            if (data.tableauTailles && data.tableauTailles.length > 0) {
                data.tableauTailles.forEach(taille => tailleSelect.add(new Option(taille, taille)));
                tailleSelect.disabled = false;
            } else {
                tailleSelect.innerHTML = '<option value="">Aucune taille disponible</option>';
            }

            if (data.tableauCouleurs && data.tableauCouleurs.length > 0) {
                data.tableauCouleurs.forEach(couleur => couleurSelect.add(new Option(couleur, couleur)));
                couleurSelect.disabled = false;
            } else {
                couleurSelect.innerHTML = '<option value="">Aucune couleur disponible</option>';
            }
            toggleSubmitButton();
        });

    });

    tailleSelect.addEventListener('change', toggleSubmitButton);
    couleurSelect.addEventListener('change', toggleSubmitButton);
});
</script>
{% endblock %}
