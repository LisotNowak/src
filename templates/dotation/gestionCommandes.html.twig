{% extends 'base.html.twig' %}

{% block title %}Gestion commandes{% endblock %}

{% block sidebar %}
    {% include 'dotation/sidebar.html.twig' with {'active_link': 'gestion_commandes'} %}
{% endblock %}

{% block body %}
<div class="container mt-4">
    {# Affichage des messages flash (erreur / success) #}
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ label == 'error' ? 'danger' : label }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endfor %}

    <h1>Gestion des commandes</h1>

    {# Onglets pour les trois vues #}
    <ul class="nav nav-tabs" id="gestionTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="valides-tab" data-bs-toggle="tab" data-bs-target="#valides" type="button" role="tab" aria-controls="valides" aria-selected="true">
                Commandes validées ({{ commandes_valide|length }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="attente-tab" data-bs-toggle="tab" data-bs-target="#attente" type="button" role="tab" aria-controls="attente" aria-selected="false">
                En attente ({{ commandes_attente|length }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="surcommande-tab" data-bs-toggle="tab" data-bs-target="#surcommande" type="button" role="tab" aria-controls="surcommande" aria-selected="false">
                Sur commandes ({{ commandes_sur_commande|length }})
            </button>
        </li>
    </ul>

    <div class="tab-content mt-3" id="gestionTabsContent">

        {# === VALIDÉES === #}
        <div class="tab-pane fade show active" id="valides" role="tabpanel" aria-labelledby="valides-tab">
            {% if commandes_valide is empty %}
                <div class="alert alert-info">Aucune commande validée.</div>
            {% else %}
                {% for entry in commandes_valide %}
                    {% set commande = entry.commande %}
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong data-user-name="{{ entry.userName }}">Commande #{{ commande.id }} || {{ commande.userMail }}</strong>
                            <span class="float-right">{{ commande.date }}</span>
                            <div class="small text-muted">État : {{ commande.nomEtat }}</div>

                            <div class="mt-2">
                                <form method="post" action="{{ path('app_commande_mettre_en_stock', {'id': commande.id}) }}" style="display:inline-block;">
                                    <input type="hidden" name="_token" value="{{ csrf_token('gestion_commande_' ~ commande.id) }}">
                                    <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Décrémenter le stock pour cette commande et passer en \"Sur stock\" ?');">
                                        Mettre en stock
                                    </button>
                                </form>

                                <form method="post" action="{{ path('app_commande_mettre_sur_commande', {'id': commande.id}) }}" style="display:inline-block;margin-left:8px;">
                                    <input type="hidden" name="_token" value="{{ csrf_token('gestion_commande_' ~ commande.id) }}">
                                    <button type="submit" class="btn btn-sm btn-warning" onclick="return confirm('Placer cette commande sur commande et passer en \"Sur commande\" ?');">
                                        Mettre sur commande
                                    </button>
                                </form>

                                {# Bouton pour mettre en attente #}
                                {% if commande.nomEtat == 'Validée' %}
                                    <form method="post" action="{{ path('app_commande_mettre_en_attente', {'id': commande.id}) }}" style="display:inline-block;margin-left:8px;">
                                        <input type="hidden" name="_token" value="{{ csrf_token('gestion_commande_' ~ commande.id) }}">
                                        <button type="submit" class="btn btn-sm btn-secondary" onclick="return confirm('Mettre cette commande en attente ?');">
                                            Mettre en attente
                                        </button>
                                    </form>
                                {% endif %}


                                <a href="{{ path('app_commande_edit', {'id': commande.id}) }}" class="btn btn-sm btn-primary" style="margin-left:8px;">Modifier</a>
                            </div>
                        </div>

                        <div class="card-body">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Réf</th>
                                        <th>Nom</th>
                                        <th>Taille</th>
                                        <th>Couleur</th>
                                        <th>Quantité</th>
                                        <th>Dispo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for it in entry.items %}
                                        <tr>
                                            <td>{{ it.article ? it.article.reference : '—' }}</td>
                                            <td>{{ it.article ? it.article.nom : 'Article supprimé' }}</td>
                                            <td>{{ it.taille }}</td>
                                            <td>{{ it.couleur }}</td>
                                            <td>{{ it.quantite }}</td>
                                            <td>{{ it.stockDisponible }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        {# === EN ATTENTE === #}
        <div class="tab-pane fade" id="attente" role="tabpanel" aria-labelledby="attente-tab">
            {% if commandes_attente is empty %}
                <div class="alert alert-info">Aucune commande en attente.</div>
            {% else %}
                {% for entry in commandes_attente %}
                    {% set commande = entry.commande %}
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong data-user-name="{{ entry.userName }}">Commande #{{ commande.id }} || {{ commande.userMail }}</strong>
                            <span class="float-right">{{ commande.date }}</span>
                            <div class="small text-muted">État : {{ commande.nomEtat }}</div>

                            <div class="mt-2">
                                <form method="post" action="{{ path('app_commande_reactiver', {'id': commande.id}) }}" style="display:inline-block;">
                                    <input type="hidden" name="_token" value="{{ csrf_token('gestion_commande_' ~ commande.id) }}">
                                    <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Remettre cette commande à l’état \"Validée\" ?');">
                                        Réactiver
                                    </button>
                                </form>

                                <a href="{{ path('app_commande_edit', {'id': commande.id}) }}" class="btn btn-sm btn-primary" style="margin-left:8px;">Modifier</a>
                            </div>
                        </div>

                        <div class="card-body">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Réf</th>
                                        <th>Nom</th>
                                        <th>Taille</th>
                                        <th>Couleur</th>
                                        <th>Quantité</th>
                                        <th>Dispo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for it in entry.items %}
                                        <tr>
                                            <td>{{ it.article ? it.article.reference : '—' }}</td>
                                            <td>{{ it.article ? it.article.nom : 'Article supprimé' }}</td>
                                            <td>{{ it.taille }}</td>
                                            <td>{{ it.couleur }}</td>
                                            <td>{{ it.quantite }}</td>
                                            <td>{{ it.stockDisponible }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        {# === SUR COMMANDE === #}
        <div class="tab-pane fade" id="surcommande" role="tabpanel" aria-labelledby="surcommande-tab">
            {% if commandes_sur_commande is empty %}
                <div class="alert alert-info">Aucune commande "Sur commande".</div>
            {% else %}

            <div class="d-flex justify-content-end mb-2">
                <button class="btn btn-sm btn-outline-primary" id="exportExcelBtn">
                    Exporter Excel
                </button>
            </div>

                {% for entry in commandes_sur_commande %}
                    {% set commande = entry.commande %}
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong data-user-name="{{ entry.userName }}">Commande #{{ commande.id }} || {{ commande.userMail }}</strong>
                            <span class="float-right">{{ commande.date }}</span>
                            <div class="small text-muted">État : {{ commande.nomEtat }}</div>

                            <div class="mt-2">
                                <form method="post" action="{{ path('app_commande_mettre_en_stock', {'id': commande.id}) }}" style="display:inline-block;">
                                    <input type="hidden" name="_token" value="{{ csrf_token('gestion_commande_' ~ commande.id) }}">
                                    <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Décrémenter le stock pour cette commande et passer en \"Sur stock\" ?');">
                                        Mettre en stock
                                    </button>
                                </form>

                                <a href="{{ path('app_commande_edit', {'id': commande.id}) }}" class="btn btn-sm btn-primary" style="margin-left:8px;">Modifier</a>
                            </div>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Réf</th>
                                        <th>Nom</th>
                                        <th>Taille</th>
                                        <th>Couleur</th>
                                        <th>Quantité</th>
                                        <th>Dispo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for it in entry.items %}
                                        <tr>
                                            <td>{{ it.article ? it.article.reference : '—' }}</td>
                                            <td>{{ it.article ? it.article.nom : 'Article supprimé' }}</td>
                                            <td>{{ it.taille }}</td>
                                            <td>{{ it.couleur }}</td>
                                            <td>{{ it.quantite }}</td>
                                            <td>{{ it.stockDisponible }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const btn = document.getElementById('exportExcelBtn');
            if (!btn) return;

            btn.addEventListener('click', function () {
                let rows = [['Commande', 'Utilisateur', 'Date', 'Réf', 'Nom', 'Taille', 'Couleur', 'Quantité', 'Dispo']]; // entêtes

                document.querySelectorAll('#surcommande .card').forEach(card => {
                    const commandeHeader = card.querySelector('.card-header strong').innerText.trim();
                    // Extraction de l'id, nom/prénom
                    const match = commandeHeader.match(/Commande #(\d+) \|\| (.+)/);
                    const commandeId = match ? match[1] : '';
                    const userName = card.querySelector('.card-header strong').dataset.userName || '';
                    const date = card.querySelector('.card-header .float-right')?.innerText.trim() || '';

                    card.querySelectorAll('table tbody tr').forEach(tr => {
                        let row = [commandeId, userName, date];
                        tr.querySelectorAll('td').forEach(td => row.push(td.innerText.trim()));
                        rows.push(row);
                    });
                });

                let csvContent = rows.map(e => e.join(",")).join("\n");
                let blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                let link = document.createElement("a");
                let url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "bon_de_commande.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        });
    </script>
{% endblock %}



