{% extends 'base.html.twig' %}

{% block title %}Gestion commandes{% endblock %}

{% block sidebar %}
    {% include 'dotation/sidebar.html.twig' with {'active_link': 'gestion_commandes'} %}
{% endblock %}

{% block body %}
<div class="container mt-4">
    {# Affichage des messages flash (erreur / success) #}
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ label == 'error' ? 'danger' : label }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endfor %}

    <h1>Gestion des commandes</h1>

    {# Onglets pour les deux vues #}
    <ul class="nav nav-tabs" id="gestionTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="valides-tab" data-bs-toggle="tab" data-bs-target="#valides" type="button" role="tab" aria-controls="valides" aria-selected="true">
                Commandes validé ({{ commandes_valide|length }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="surcommande-tab" data-bs-toggle="tab" data-bs-target="#surcommande" type="button" role="tab" aria-controls="surcommande" aria-selected="false">
                Sur commandes ({{ commandes_sur_commande|length }})
            </button>
        </li>
    </ul>

    <div class="tab-content mt-3" id="gestionTabsContent">
        <div class="tab-pane fade show active" id="valides" role="tabpanel" aria-labelledby="valides-tab">
            {% if commandes_valide is empty %}
                <div class="alert alert-info">Aucune commande validée.</div>
            {% else %}
                {% for entry in commandes_valide %}
                    {% set commande = entry.commande %}
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>Commande #{{ commande.id }} || {{ commande.userMail }}</strong>
                            <span class="float-right">{{ commande.date }}</span>
                            <div class="small text-muted">État : {{ commande.nomEtat }}</div>

                            <div class="mt-2">
                                <form method="post" action="{{ path('app_commande_mettre_en_stock', {'id': commande.id}) }}" style="display:inline-block;">
                                    <input type="hidden" name="_token" value="{{ csrf_token('gestion_commande_' ~ commande.id) }}">
                                    <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Décrémenter le stock pour cette commande et passer en \"Sur stock\" ?');">
                                        Mettre en stock
                                    </button>
                                </form>

                                <form method="post" action="{{ path('app_commande_mettre_sur_commande', {'id': commande.id}) }}" style="display:inline-block;margin-left:8px;">
                                    <input type="hidden" name="_token" value="{{ csrf_token('gestion_commande_' ~ commande.id) }}">
                                    <button type="submit" class="btn btn-sm btn-warning" onclick="return confirm('Placer cette commande sur commande et passer en \"Sur commande\" ?');">
                                        Mettre sur commande
                                    </button>
                                </form>
                            </div>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Réf</th>
                                        <th>Nom</th>
                                        <th>Taille</th>
                                        <th>Couleur</th>
                                        <th>Quantité</th>
                                        <th>Dispo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for it in entry.items %}
                                        <tr>
                                            <td>{{ it.article ? it.article.reference : '—' }}</td>
                                            <td>{{ it.article ? it.article.nom : 'Article supprimé' }}</td>
                                            <td>{{ it.taille }}</td>
                                            <td>{{ it.couleur }}</td>
                                            <td>{{ it.quantite }}</td>
                                            <td>{{ it.stockDisponible }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <div class="tab-pane fade" id="surcommande" role="tabpanel" aria-labelledby="surcommande-tab">
            {% if commandes_sur_commande is empty %}
                <div class="alert alert-info">Aucune commande "Sur commande".</div>
            {% else %}
                {% for entry in commandes_sur_commande %}
                    {% set commande = entry.commande %}
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>Commande #{{ commande.id }} || {{ commande.userMail }}</strong>
                            <span class="float-right">{{ commande.date }}</span>
                            <div class="small text-muted">État : {{ commande.nomEtat }}</div>

                            <div class="mt-2">
                                {# Pour les commandes déjà "Sur commande" on peut par exemple proposer de repasser en "Sur stock" si souhaité #}
                                <form method="post" action="{{ path('app_commande_mettre_en_stock', {'id': commande.id}) }}" style="display:inline-block;">
                                    <input type="hidden" name="_token" value="{{ csrf_token('gestion_commande_' ~ commande.id) }}">
                                    <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Décrémenter le stock pour cette commande et passer en \"Sur stock\" ?');">
                                        Mettre en stock
                                    </button>
                                </form>
                            </div>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Réf</th>
                                        <th>Nom</th>
                                        <th>Taille</th>
                                        <th>Couleur</th>
                                        <th>Quantité</th>
                                        <th>Dispo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for it in entry.items %}
                                        <tr>
                                            <td>{{ it.article ? it.article.reference : '—' }}</td>
                                            <td>{{ it.article ? it.article.nom : 'Article supprimé' }}</td>
                                            <td>{{ it.taille }}</td>
                                            <td>{{ it.couleur }}</td>
                                            <td>{{ it.quantite }}</td>
                                            <td>{{ it.stockDisponible }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>

</div>
{% endblock %}