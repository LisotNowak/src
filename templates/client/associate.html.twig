{% extends 'base.html.twig' %}

{% block title %}Association Clients / Signataires{% endblock %}

{% block body %}
<div class="container mt-4">
    <a href="{{ path('app_clients_list') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Retour √† la liste
    </a>
    <h2 class="mb-4 text-center">üîó Associer des clients √† un ou plusieurs signataires</h2>

    {# Flash messages #}
    {% for message in app.flashes('success') %}
        <div class="alert alert-success">{{ message }}</div>
    {% endfor %}
    {% for message in app.flashes('error') %}
        <div class="alert alert-danger">{{ message }}</div>
    {% endfor %}

    <form method="POST" action="{{ path('app_client_associate') }}">
        <div class="row mb-4">
            <div class="col-md-6">
                <label class="form-label fw-bold">S√©lectionnez un ou plusieurs signataires :</label>
                <select name="signataires[]" class="form-select" multiple required>
                    {% for signataire in signataires %}
                        <option value="{{ signataire.id }}">{{ signataire.nom }}</option>
                    {% endfor %}
                </select>
                <small class="text-muted">Maintenez Ctrl (ou Cmd sur Mac) pour une s√©lection multiple.</small>
            </div>
        </div>

        <hr>

        <div class="row">
            <div class="col-md-7">
                <h5>üìã Liste des clients disponibles</h5>
                <input type="text" id="searchClient" class="form-control mb-2" placeholder="Rechercher un client...">

                <div id="clientsList" class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                    {% for client in clients %}
                        <div class="form-check mb-1">
                            <input 
                                class="form-check-input client-checkbox" 
                                type="checkbox" 
                                name="clients[]" 
                                id="client_{{ client.id }}" 
                                value="{{ client.id }}"
                            >
                            <label class="form-check-label" for="client_{{ client.id }}">
                                {{ client.triNom|upper }} {{ client.triPrenom }}
                                <span class="text-muted small">
                                    - {{ client.ville ?? '' }} ({{ client.codePostal ?? '' }})
                                </span>
                            </label>
                        </div>
                    {% else %}
                        <p class="text-muted fst-italic">Aucun client trouv√©.</p>
                    {% endfor %}
                </div>
            </div>

            <div class="col-md-5">
                <h5>‚úÖ Clients s√©lectionn√©s</h5>
                <ul id="selectedClients" class="list-group small">
                    <li class="list-group-item text-muted">Aucun client s√©lectionn√© pour le moment.</li>
                </ul>
            </div>
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary px-5 py-2">
                Associer les clients s√©lectionn√©s
            </button>
        </div>
    </form>
</div>

<script>
// üîç Filtrer la liste des clients en direct
document.getElementById('searchClient').addEventListener('input', function() {
    const filter = this.value.toLowerCase();
    document.querySelectorAll('#clientsList .form-check').forEach(div => {
        const label = div.textContent.toLowerCase();
        div.style.display = label.includes(filter) ? '' : 'none';
    });
});

// ‚úÖ Mettre √† jour la liste des clients s√©lectionn√©s
const clientCheckboxes = document.querySelectorAll('.client-checkbox');
const selectedList = document.getElementById('selectedClients');

function refreshSelectedList() {
    selectedList.innerHTML = '';
    const selected = Array.from(clientCheckboxes).filter(cb => cb.checked);

    if (selected.length === 0) {
        selectedList.innerHTML = '<li class="list-group-item text-muted">Aucun client s√©lectionn√© pour le moment.</li>';
        return;
    }

    selected.forEach(cb => {
        const label = document.querySelector(`label[for="${cb.id}"]`).innerText;
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = label;
        selectedList.appendChild(li);
    });
}

clientCheckboxes.forEach(cb => cb.addEventListener('change', refreshSelectedList));
</script>
{% endblock %}
